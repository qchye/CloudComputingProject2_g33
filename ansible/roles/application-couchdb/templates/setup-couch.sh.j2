export declare -a nodes=()

{% for node_num in {{cluster_size}} %}
    docker service create\
        --name couchdb{{node_num}}\
        --constraint node.label=={{groups['backend_nodes'][{{node_num}}]}}\
        --publish mode=host,target=5984,published=5984\
        --publish mode=host,target=9100,published=9100\
        --publish mode=host,target=4369,published=4369\
        --mount type=bind,src=/opt/couchdb/data,dst=/opt/data\
        --env COUCHDB_USER={{user}}}\
        --env COUCHDB_PASSWORD={{pass}}}\
        --env NODENAME=couchdb@{{groups['backend_nodes'][{{node_num}}]}}\
        --env COUCHDB_SECRET={{cookie}}\
        --env ERL_FLAGS="-setcookie \"{{cookie}}\" -name \"couchdb@{{groups['backend_nodes'][{{node_num}}]}}\""\
        ibmcom/couchdb3:3.0.0

    nodes+=({{groups['backend_nodes'][{{node_num}}]}})
{% endfor %}


export masternode=echo ${nodes} | cut -f1 -d' '
export declare -a othernodes=echo ${nodes[@]} | sed s/${masternode}//

for node in ${othernodes}
do
    curl -XPOST "http://{{user}}:{{pass}}@${masternode}:5984/_cluster_setup" \
        --header "Content-Type: application/json"\
        --data "{\"action\": \"enable_cluster\", \"bind_address\":\"0.0.0.0\",\
                \"username\": \"{{user}}\", \"password\":\"{{pass}}\", \"port\": \"5984\",\
                \"remote_node\": \"${node}\", \"node_count\": \"{{cluster_size}}\",\
                \"remote_current_user\":\"{{user}}\", \"remote_current_password\":\"{{pass}}\"}"
done

for node in ${othernodes}
do
    curl -XPOST "http://{{user}}}:{{pass}}@${masternode}:5984/_cluster_setup"\
        --header "Content-Type: application/json"\
        --data "{\"action\": \"add_node\", \"host\":\"${node}\",\
                \"port\": \"5984\", \"username\": \"{{user}}\", \"password\":\"{{pass}}\"}"
done

curl -XPOST "http://{{user}}:{{pass}}@${masternode}:5984/_cluster_setup"\
    --header "Content-Type: application/json" --data "{\"action\": \"finish_cluster\"}"